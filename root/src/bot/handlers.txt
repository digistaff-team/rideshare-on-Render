import asyncio
import logging
import json
import re
from datetime import datetime, timedelta
from sqlalchemy import delete, select, update
from aiogram import Router, types, F
from aiogram.filters import Command
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

from src.database.session import async_session
from src.database.models import User, Ride, Booking
from src.services.nlu import NLUProcessor

logger = logging.getLogger(__name__)
router = Router()
nlu = NLUProcessor()

class RideForm(StatesGroup):
    chatting_with_ai = State()

def main_kb():
    kb = [
        [KeyboardButton(text="üôã –ü–æ–¥–≤–µ–∑–∏"), KeyboardButton(text="üöó –ü–æ–¥–≤–µ–∑—É")],
        [KeyboardButton(text="üîç –ù–∞–π—Ç–∏ –ø–æ–ø—É—Ç—á–∏–∫–æ–≤"), KeyboardButton(text="üìã –ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏")]
    ]
    return ReplyKeyboardMarkup(keyboard=kb, resize_keyboard=True)

# --- –§–û–ù–û–í–´–ï –ó–ê–î–ê–ß–ò ---
async def auto_clean_old_rides():
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –ø–æ–µ–∑–¥–æ–∫ (—Å—Ç–∞—Ä—à–µ 2 –¥–Ω–µ–π)"""
    while True:
        try:
            async with async_session() as session:
                limit = datetime.utcnow() - timedelta(days=2)
                # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–µ–∑–¥–∫–∏
                await session.execute(delete(Ride).where(Ride.created_at < limit))
                # –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                await session.execute(delete(Booking).where(
                    Booking.created_at < limit
                ))
                await session.commit()
                logger.info("–§–æ–Ω–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.")
            await asyncio.sleep(43200)  # –†–∞–∑ –≤ 12 —á–∞—Å–æ–≤
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏: {e}")
            await asyncio.sleep(3600)

# --- –ü–†–ò–í–ï–¢–°–¢–í–ò–ï ---
@router.message(Command("start"))
async def start(m: types.Message, state: FSMContext):
    await state.clear()
    async with async_session() as session:
        result = await session.execute(select(User).where(User.telegram_id == m.from_user.id))
        if not result.scalar():
            session.add(User(telegram_id=m.from_user.id, username=m.from_user.username))
            await session.commit()
    
    welcome_text = (
        "–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –ø–æ–ø—É—Ç—á–∏–∫–æ–≤.\n\n"
        "–ï—Å–ª–∏ –≤—ã –ø–∞—Å—Å–∞–∂–∏—Ä ‚Äî –Ω–∞–∂–º–∏—Ç–µ **üôã –ü–æ–¥–≤–µ–∑–∏**\n"
        "–ï—Å–ª–∏ –≤—ã –≤–æ–¥–∏—Ç–µ–ª—å ‚Äî –Ω–∞–∂–º–∏—Ç–µ **üöó –ü–æ–¥–≤–µ–∑—É**"
    )
    await m.answer(welcome_text, reply_markup=main_kb(), parse_mode="Markdown")

# --- –í–´–ë–û–† –†–û–õ–ò ---
@router.message(F.text.in_(["üôã –ü–æ–¥–≤–µ–∑–∏", "üöó –ü–æ–¥–≤–µ–∑—É"]))
async def ask_route(m: types.Message, state: FSMContext):
    role = "passenger" if "üôã" in m.text else "driver"
    await state.update_data(role=role)
    await state.set_state(RideForm.chatting_with_ai)
    
    text = (
        "–ù–∞–ø–∏—à–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç –ø–æ–µ–∑–¥–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: *'–ò–∑ –ó–¥—Ä–∞–≤–æ–≥–æ –≤ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä –∑–∞–≤—Ç—Ä–∞ –≤ 9 —É—Ç—Ä–∞'*."
        if role == "passenger" else
        "–ù–∞–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª–∏: *'–ï–¥—É –∏–∑ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞ –≤ –ó–¥—Ä–∞–≤–æ–µ 27.12 –≤ 18:00, –µ—Å—Ç—å 3 –º–µ—Å—Ç–∞'*."
    )
    await m.answer(text, parse_mode="Markdown")

# --- –ì–õ–ê–í–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–ò–ê–õ–û–ì–ê ---
@router.message(RideForm.chatting_with_ai)
@router.message(F.text & ~F.text.startswith("/"))
async def handle_ai_conversation(m: types.Message, state: FSMContext):
    res = await nlu.parse_intent(m.text, m.from_user.id)
    
    if not res:
        return await m.answer("–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")

    # –ï—Å–ª–∏ –ò–ò —Å–æ–±—Ä–∞–ª –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON) ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–µ–∑–¥–∫—É
    if res.get("origin") and res.get("destination") and res.get("date"):
        await process_ride_data(m, res, state)
    
    # –í—ã–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò (–±–æ–ª—Ç–æ–≤–Ω—è, —É—Ç–æ—á–Ω–µ–Ω–∏–µ –∏–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
    ai_reply = res.get("raw_text")
    if ai_reply:
        await m.answer(ai_reply)
    elif not res.get("origin"):
        await m.answer("–Ø –≤–∞—Å –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª. –£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—É–¥–∞ –∏ –∫—É–¥–∞ –≤—ã –µ–¥–µ—Ç–µ?")

async def process_ride_data(m: types.Message, res: dict, state: FSMContext):
    data = await state.get_data()
    role = data.get('role', 'passenger')
    
    async with async_session() as s:
        user_stmt = await s.execute(select(User).where(User.telegram_id == m.from_user.id))
        user = user_stmt.scalar()
        if not user: return

        seats = int(res.get('seats', 1 if role == 'passenger' else 3))  # Default –¥–ª—è driver 3, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ
        new_ride = Ride(
            user_id=user.id,
            origin=res['origin'],
            destination=res['destination'],
            ride_date=res['date'],  # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç NLU, e.g. "2025-12-27"
            start_time=res.get('start_time', '–ù–µ —É–∫–∞–∑–∞–Ω–æ'),
            initial_seats=seats,
            seats=seats,
            role=role
        )
        s.add(new_ride)
        await s.commit()
        await s.refresh(new_ride)

        await m.answer(f"‚úÖ –ü–æ–µ–∑–¥–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!", reply_markup=main_kb())

        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π
        if role == 'driver':
            await match_passengers(m, new_ride, res, user)

    await state.clear()

async def match_passengers(m: types.Message, new_ride: Ride, res: dict, user: User):
    async with async_session() as s:
        matches_stmt = await s.execute(
            select(Ride, User).join(User).where(
                Ride.origin.ilike(f"%{res['origin']}%"),
                Ride.destination.ilike(f"%{res['destination']}%"),
                Ride.ride_date == res['date'],
                Ride.role == 'passenger',
                Ride.user_id != user.id
            )
        )
        matches = matches_stmt.all()

        for r_obj, match_user in matches:
            if new_ride.seats > 0:
                kb = InlineKeyboardBuilder()
                kb.button(text="‚úÖ –í–∑—è—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–∞", callback_data=f"take_{r_obj.id}_{new_ride.id}")
                
                match_msg = (
                    f"üîî *–ù–∞–π–¥–µ–Ω –ø–æ–ø—É—Ç—á–∏–∫!*\n"
                    f"üìç {r_obj.origin} ‚û°Ô∏è {r_obj.destination}\n"
                    f"üìÖ –î–∞—Ç–∞: {r_obj.ride_date}\n"
                    f"üïí –í—Ä–µ–º—è: {r_obj.start_time}\n"
                    f"üë§ –ö–æ–Ω—Ç–∞–∫—Ç: @{match_user.username or '—Å–∫—Ä—ã—Ç'}"
                )
                try:
                    await m.bot.send_message(m.from_user.id, match_msg, reply_markup=kb.as_markup(), parse_mode="Markdown")
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—é: {e}")

# --- –ü–û–ò–°–ö –ü–û–ü–£–¢–ß–ò–ö–û–í ---
@router.message(F.text == "üîç –ù–∞–π—Ç–∏ –ø–æ–ø—É—Ç—á–∏–∫–æ–≤")
async def find_rides(m: types.Message):
    async with async_session() as s:
        rides_stmt = await s.execute(
            select(Ride, User).join(User).where(
                Ride.created_at > datetime.utcnow() - timedelta(days=2),
                (Ride.role == 'driver') & (Ride.seats > 0) | (Ride.role == 'passenger')
            ).order_by(Ride.created_at.desc()).limit(10)
        )
        rides = rides_stmt.all()
        
        if not rides:
            return await m.answer("–ù–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π.")
        
        for r, u in rides:
            seats_text = f"–ú–µ—Å—Ç: {r.seats}" if r.role == 'driver' else ""
            txt = (
                f"{'üöó –í–æ–¥–∏—Ç–µ–ª—å' if r.role == 'driver' else 'üôã –ü–∞—Å—Å–∞–∂–∏—Ä'}\n"
                f"üìç {r.origin} -> {r.destination}\n"
                f"üìÖ {r.ride_date} | {r.start_time}\n"
                f"{seats_text}\n"
                f"üë§ @{u.username or '—Å–∫—Ä—ã—Ç'}"
            )
            await m.answer(txt, parse_mode="Markdown")

# --- –ö–ù–û–ü–ö–ò –ú–û–ò –ü–û–ï–ó–î–ö–ò ---
@router.message(F.text == "üìã –ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏")
async def list_rides(m: types.Message):
    async with async_session() as s:
        user_stmt = await s.execute(select(User.id).where(User.telegram_id == m.from_user.id))
        u_id = user_stmt.scalar()
        rides_stmt = await s.execute(select(Ride).where(Ride.user_id == u_id))
        rides = rides_stmt.scalars().all()
        
        if not rides:
            return await m.answer("–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫.")
        
        for r in rides:
            txt = f"üìç {r.origin} -> {r.destination}\nüìÖ {r.ride_date} | {r.start_time}"
            kb = InlineKeyboardBuilder().button(text="‚ùå –£–¥–∞–ª–∏—Ç—å", callback_data=f"del_{r.id}").as_markup()
            await m.answer(txt, reply_markup=kb)

# --- CALLBACKS ---
@router.callback_query(F.data.startswith("take_"))
async def take_passenger(cb: types.CallbackQuery):
    _, p_ride_id, d_ride_id = cb.data.split("_")
    p_ride_id = int(p_ride_id)
    d_ride_id = int(d_ride_id)
    
    async with async_session() as s:
        driver_ride = await s.get(Ride, d_ride_id)
        if not driver_ride or driver_ride.seats <= 0:
            return await cb.answer("–ú–µ—Å—Ç–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!", show_alert=True)
        
        # –°–æ–∑–¥–∞–µ–º pending booking
        new_booking = Booking(
            driver_ride_id=d_ride_id,
            passenger_ride_id=p_ride_id,
            status='pending'
        )
        s.add(new_booking)
        await s.commit()
        await s.refresh(new_booking)
        
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–∞—Å—Å–∞–∂–∏—Ä–∞
        p_user_stmt = await s.execute(select(User.telegram_id, User.username).join(Ride).where(Ride.id == p_ride_id))
        p_tid, p_username = p_user_stmt.first()
        
        kb = InlineKeyboardBuilder()
        kb.button(text="ü§ù –ï–¥—É —Å –≤–∞–º–∏", callback_data=f"confirm_{new_booking.id}")
        
        match_msg = (
            f"üîî *–í–æ–¥–∏—Ç–µ–ª—å –≥–æ—Ç–æ–≤ –≤–∞—Å –ø–æ–¥–≤–µ–∑—Ç–∏!*\n"
            f"üìç {driver_ride.origin} ‚û°Ô∏è {driver_ride.destination}\n"
            f"üìÖ –î–∞—Ç–∞: {driver_ride.ride_date}\n"
            f"üïí –í—Ä–µ–º—è: {driver_ride.start_time}\n"
            f"üë§ –ö–æ–Ω—Ç–∞–∫—Ç: @{cb.from_user.username or '—Å–∫—Ä—ã—Ç'}"
        )
        try:
            await cb.bot.send_message(p_tid, match_msg, reply_markup=kb.as_markup(), parse_mode="Markdown")
            await cb.answer("–ü–∞—Å—Å–∞–∂–∏—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω!")
            await cb.message.edit_text(cb.message.text + "\n\nüì© –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∞—Å—Å–∞–∂–∏—Ä—É")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–∞—Å—Å–∞–∂–∏—Ä—É: {e}")

@router.callback_query(F.data.startswith("confirm_"))
async def confirm_booking(cb: types.CallbackQuery):
    _, booking_id = cb.data.split("_")
    booking_id = int(booking_id)
    
    async with async_session() as s:
        booking = await s.get(Booking, booking_id)
        if not booking or booking.status != 'pending':
            return await cb.answer("–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ!", show_alert=True)
        
        driver_ride = await s.get(Ride, booking.driver_ride_id)
        if driver_ride.seats <= 0:
            booking.status = 'rejected'
            await s.commit()
            await cb.answer("–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º–µ—Å—Ç–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!", show_alert=True)
            await cb.message.edit_text(cb.message.text + "\n\n‚ùå –ú–µ—Å—Ç–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å")
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤–æ–¥–∏—Ç–µ–ª—è? –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
            return
        
        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º
        booking.status = 'confirmed'
        await s.execute(update(Ride).where(Ride.id == booking.driver_ride_id).values(seats=Ride.seats - 1))
        await s.commit()
        
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–±–æ–∏—Ö
        d_user_stmt = await s.execute(select(User.telegram_id).join(Ride).where(Ride.id == booking.driver_ride_id))
        d_tid = d_user_stmt.scalar()
        
        await cb.bot.send_message(d_tid, "üéâ –ü–∞—Å—Å–∞–∂–∏—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–µ–∑–¥–∫—É! –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—É—Ç–∏!")
        await cb.answer("–ü–æ–µ–∑–¥–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!")
        await cb.message.edit_text(cb.message.text + "\n\n‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ")

@router.callback_query(F.data.startswith("del_"))
async def delete_ride(cb: types.CallbackQuery):
    r_id = int(cb.data.split("_")[1])
    async with async_session() as s:
        ride = await s.get(Ride, r_id)
        if ride:
            await s.delete(ride)
            await s.commit()
            await cb.answer("–ü–æ–µ–∑–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞")
            await cb.message.delete()